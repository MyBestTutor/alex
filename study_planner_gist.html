<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì„œìœ¤ì´ ê³µë¶€ í”Œë˜ë„ˆ</title>
<style>
:root{ --bg:#ffffff; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --brand:#5c7cfa; --ok:#72d6b1; --warn:#f7c87b; --danger:#ff8f7a; --border:#e6e9ef; --shadow:0 6px 18px rgba(15,23,42,.06); --radius:16px; }
*{box-sizing:border-box}
html,body{margin:0; padding:0; color:var(--ink); background:var(--bg); font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",Arial;}
.header{position:sticky; top:0; z-index:20; background:rgba(255,255,255,.96); border-bottom:1px solid var(--border); backdrop-filter:saturate(180%) blur(6px)}
.container{max-width:1100px; margin:0 auto; padding:12px}
.h1{display:flex; gap:8px; align-items:center}
h1{margin:0; font-size:20px; letter-spacing:-.2px}
.sub{color:#475569; font-weight:800; font-size:12px}
.row{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:4px}
.btn{border:1px solid var(--border); background:#f7f8fd; color:#0f172a; padding:8px 12px; border-radius:12px; font-weight:800; cursor:pointer; box-shadow:var(--shadow)}
.btn.primary{background:var(--brand); color:#fff; border-color:transparent}
.btn.success{background:var(--ok); color:#0f172a; border-color:transparent}
.btn.warn{background:var(--warn); color:#0f172a; border-color:transparent}
.btn.danger{background:var(--danger); color:#fff; border-color:transparent}
.badge{background:#eef2ff; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px}
.tabs{display:flex; gap:6px; margin-left:auto}
.tab{padding:8px 12px; border-radius:999px; background:#f6f7fb; border:1px solid var(--border); color:#0f172a; font-weight:800; cursor:pointer; user-select:none}
.tab.active{background:var(--brand); color:#fff; border-color:transparent}
.hidden{display:none !important}
.card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:visible}
.card .title{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid var(--border); font-weight:900}
.card .body{padding:10px 12px}
.small{font-size:12px; color:var(--muted); font-variant-numeric: tabular-nums;}
.tiny{font-size:11px; color:#64748b}
.board{display:grid; grid-template-columns: 1.1fr 1fr; gap:12px; margin-top:12px}
@media (max-width: 1000px){ .board{grid-template-columns: 1fr} }
.board .col{display:flex; flex-direction:column; gap:12px}
.kbar{height:10px; background:#e8eefc; border-radius:999px; overflow:hidden}
.kbar>span{display:block; height:100%; background:var(--brand)}
.tcard{padding:8px; border:1px solid var(--border); border-radius:12px; background:#fff}
.thead{display:flex; gap:6px; align-items:center; font-weight:900; font-size:13px}
.info{font-size:12px; color:#64748b; margin-top:4px; font-variant-numeric: tabular-nums;}
.badge-chip{display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px}
.tag{display:flex; align-items:center; gap:6px; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#fff; font-size:13px; white-space:nowrap}
.tag input[type="checkbox"]{transform:scale(1.1)}
.tag.done{background:#e8ffe8; border-color:#baf7c0}
.minibar{height:8px; border-radius:999px; background:#e5e7eb; overflow:hidden; margin-top:4px}
.minibar>span{display:block; height:100%; background:linear-gradient(90deg, var(--brand), var(--ok))}
.table{width:100%; border-collapse:collapse}
.table th,.table td{border:1px solid var(--border); padding:8px; text-align:center; font-size:13px; vertical-align:top}
.table th{background:#f6f7fb}
.left{text-align:left}
.grid{display:grid; gap:10px}
.grid-2{grid-template-columns:1fr 1fr}
.daybtn{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer; user-select:none; background:#fff}
.daybtn.on{background:#eef2ff; border-color:#c7d2fe}
.daybtn:focus{outline:2px solid #c7d2fe; outline-offset:2px}

@media print{
  body *{ visibility:hidden !important; }
  #print-sheet, #print-sheet *{ visibility:visible !important; }
  #print-sheet{ position:absolute; left:0; top:0; width:100%; }
}

</style>
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="row">
        <div class="h1">
          <h1>ì„œìœ¤ì´ ê³µë¶€ í”Œë˜ë„ˆ</h1>
          <span class="sub">ì˜¤ëŠ˜ë„ ë°˜ì§ë°˜ì§ ğŸŒŸ</span>
        </div>
        <span class="badge">ì´ë²ˆ ì£¼: <span id="week-range"></span></span>
        <div class="tabs">
          <div class="tab active" data-action="tab:dashboard" tabindex="0">ëŒ€ì‹œë³´ë“œ</div>
          <div class="tab" data-action="tab:routine" tabindex="0">ì„¤ì •</div>
        </div>
        <button class="btn primary" data-action="export">ë‚´ë³´ë‚´ê¸°</button>
        <label class="btn success" for="import-file">ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <input type="file" id="import-file" accept="application/json" style="display:none">
      </div>
    </div>
  </div>

  <section id="view-dashboard">
    <div class="container">
      <div class="board">
        <div class="col">
          <div class="card">
            <div class="title">ì˜¤ëŠ˜ í•  ì¼ <button class="btn" id="btn-print-today" style="margin-left:auto">ì˜¤ëŠ˜ í•  ì¼ ì¸ì‡„</button></div>
            <div class="body" id="today-list"><div class="tiny">ì˜¤ëŠ˜ë¡œ ë°°ì •ëœ í•­ëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div></div>
          </div>
          <div class="card">
            <div class="title">ë°€ë¦° í•  ì¼ (ì´ë²ˆ ì£¼)</div>
            <div class="body" id="backlog-list"><div class="tiny">ì´ë²ˆ ì£¼ì— ì•„ì§ ì™„ë£Œí•˜ì§€ ì•Šì€ í•­ëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. (í•´í”¼ë°ì´ëŠ” ì œì™¸)</div></div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <div class="title">ì´ë²ˆ ì£¼ í•œ ì¼ í•©ê³„</div>
            <div class="body" id="weekly-summary">
              <div class="kbar"><span id="weekly-bar" style="width:0%"></span></div>
              <div class="small" id="weekly-text" style="margin-top:6px">ë°°ì • 0 Â· ì™„ë£Œ 0</div>
              <div id="weekly-list" style="margin-top:8px" class="grid grid-2"></div>
            </div>
          </div>
          <div class="card">
            <div class="title">ìŠ¤í‹°ì»¤ & í•´í”¼ë°ì´</div>
            <div class="body">
              <div class="small">ë³´ìœ  ìŠ¤í‹°ì»¤: <strong id="sticker-count">0</strong>ê°œ Â· ë³´ìœ  ì¿ í°: <strong id="coupon-count">0</strong>ì¥</div>
              <div class="row" style="margin-top:6px">
                <button class="btn" id="btn-convert-coupon">ìŠ¤í‹°ì»¤ â†’ ì¿ í° ì „í™˜ (50ê°œ)</button>
              </div>
              <div class="row" style="margin-top:6px">
                <input type="date" id="coupon-date" class="select" style="padding:8px 10px;border:1px solid var(--border);border-radius:10px">
                <button class="btn warn" id="btn-use-coupon">í•´í”¼ë°ì´ ì¿ í° ì ìš©</button>
                <div class="tiny" id="coupon-help">* ì „í™˜: ìŠ¤í‹°ì»¤ 50ê°œ â†’ ì¿ í° 1ì¥. ì ìš©: ë³´ìœ  ì¿ í° 1ì¥ì„ ì‚¬ìš©í•´ <strong>ì„ íƒí•œ ë‚ ì§œ</strong>ë¥¼ í•´í”¼ë°ì´ë¡œ ì§€ì •.</div>
              </div>
              <div class="tiny" id="coupon-status" style="margin-top:6px"></div>
            
      <div class="card" style="margin-top:10px">
        <div class="title">í´ë¼ìš°ë“œ ë™ê¸°í™” (GitHub Gist)</div>
        <div class="body">
          <div class="tiny" style="margin-bottom:8px">
            * ê¹ƒí—ˆë¸Œ <strong>Personal Access Token</strong>(gist ê¶Œí•œ í•„ìš”)ê³¼ <strong>Gist ID</strong>ë¥¼ ì €ì¥í•´ë‘ë©´, ê¸°ê¸° ê°„ì— ë°ì´í„°ë¥¼ ë™ê¸°í™”í•  ìˆ˜ ìˆì–´ìš”.
          </div>
          <div class="grid grid-2">
            <input id="gist-token" class="select" placeholder="GitHub Token (gist ê¶Œí•œ)" />
            <input id="gist-id" class="select" placeholder="Gist ID (ì²˜ìŒ ì €ì¥ ì‹œ ìë™ ìƒì„±)" />
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="btn-gist-save">Gistì— ì €ì¥</button>
            <button class="btn" id="btn-gist-load">Gistì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          </div>
          <div class="tiny" id="gist-status" style="margin-top:6px;color:#334155"></div>
          <div class="tiny" style="margin-top:6px;color:#64748b">
            Â· í† í°/IDëŠ” ì´ ë¸Œë¼ìš°ì €ì˜ <code>localStorage</code>ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤. (ë‹¤ë¥¸ ê¸°ê¸°ì—” ê³µìœ ë˜ì§€ ì•ŠìŒ)<br/>
            Â· ê³µê°œ ë°ì´í„°ê°€ ê±±ì •ëœë‹¤ë©´ Gistë¥¼ <strong>secret</strong>ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”.
          </div>
        </div>
      </div>

</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="view-routine" class="hidden">
    <div class="container">
      <div class="card">
        <div class="title">ê³¼ì œ ëª©ë¡</div>
        <div class="body">
          <table class="table" id="routine-task-table">
            <thead><tr><th>ê³¼ëª©</th><th class="left">ì œëª©</th><th>ë‹¨ìœ„ ë¶„</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="row" style="margin-top:6px">
            <input class="select" id="r-new-subj" placeholder="ê³¼ëª© (ì˜ˆ: ì˜ì–´)">
            <input class="select" id="r-new-title" placeholder="ì œëª© (ì˜ˆ: ë‹¨ì–´ 20ê°œ)">
            <input class="select" id="r-new-min" type="number" min="5" step="5" placeholder="ë¶„" style="width:120px">
            <button class="btn primary" id="r-btn-task-add">ì¶”ê°€</button>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="title">ìš”ì¼ë³„ ë°°ì • (on/off)</div>
        <div class="body">
          <table class="table" id="routine-plan-table">
            <thead>
              <tr><th class="left">ê³¼ì œ</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th><th>ì£¼ê°„ í•©ê³„</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="title">ë°ì´í„°</div>
        <div class="body">
          <div class="row">
            <button class="btn" id="btn-reset-week">ì´ë²ˆ ì£¼ ì™„ë£Œ ê¸°ë¡ ì§€ìš°ê¸°</button>
            <button class="btn danger" id="btn-reset-all">ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>
    </div>
  </section>

<script>
/* ===== Storage & Utils ===== */
const Store={ get(k){try{return localStorage.getItem(k)}catch(e){return null}}, set(k,v){try{localStorage.setItem(k,v)}catch(e){} } };
const SAVE_KEY="midplanner:elem:v1";
// â˜… í˜¸í™˜ ë¡œë”©ìš© í‚¤ ëª©ë¡ (midplannerì˜ ì˜ˆì „ í‚¤ë“¤ë„ í¬í•¨) 
const COMPAT_KEYS=[
  "midplanner:elem:v1",
  "midplanner:v6h","midplanner:v6e","midplanner:v6d",
  "midplanner:v6c","midplanner:v6b","midplanner:v6a","midplanner:v6"
];

const pad=n=>n<10?`0${n}`:`${n}`;
const fmtDate=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
function getISOWeek(d){ const date=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const dayNum=date.getUTCDay()||7; date.setUTCDate(date.getUTCDate()+4-dayNum); const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1)); const weekNo=Math.ceil((((date-yearStart)/86400000)+1)/7); return [date.getUTCFullYear(), weekNo]; }
function weekStartEnd(isoYear, isoWeek){ const simple=new Date(Date.UTC(isoYear,0,4)); const dayOfWeek=simple.getUTCDay()||7; const monday=new Date(simple); monday.setUTCDate(simple.getUTCDate()-dayOfWeek+1+(isoWeek-1)*7); const sunday=new Date(monday); sunday.setUTCDate(monday.getUTCDate()+6); return [monday, sunday]; }
const uid=()=>Math.random().toString(36).slice(2,10);
const dateToKDay=ds=>["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][new Date(ds+"T00:00:00").getDay()];
function parseLocalDate(ds){ const [y,m,d]=ds.split('-').map(Number); return new Date(y,(m||1)-1,(d||1),0,0,0,0); }
function isBetweenDates(ds,start,end){ try{ const t=parseLocalDate(ds).getTime(); const s=new Date(start.getFullYear(),start.getMonth(),start.getDate()).getTime(); const e=new Date(end.getFullYear(),end.getMonth(),end.getDate()).getTime(); return t>=s&&t<=e; }catch(_){ return false; } }

/* ===== State ===== */
let state={ routine:null, stickers:0, coupons:0, awardedDates:{}, happyDays:{} };

/* ===== Init ===== */
document.addEventListener('DOMContentLoaded',()=>{
  const [y,w]=getISOWeek(new Date()); const [ws,we]=weekStartEnd(y,w);
  document.getElementById('week-range').textContent=`${fmtDate(new Date(ws))} ~ ${fmtDate(new Date(we))}`;
  load(); if(!state.routine) seedRoutine(); ensureGamify();
  // tab handlers (click + keyboard)
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click',()=>{ const act=tab.dataset.action; if(act?.startsWith('tab:')) setTab(act.split(':')[1]); });
    tab.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); tab.click(); }});
  });
  // export
  document.body.addEventListener('click',e=>{ const a=e.target.closest('[data-action="export"]'); if(!a) return; const out=JSON.stringify(state,null,2); const link=document.createElement('a'); link.href=URL.createObjectURL(new Blob([out],{type:'application/json'})); link.download=`elem_planner_${new Date().toISOString().slice(0,10)}.json`; link.click(); });
  // import
  const input=document.getElementById('import-file');
  input.addEventListener('change',e=>{ if(!e.target.files?.length) return; const reader=new FileReader(); reader.onload=()=>{ try{ const obj=JSON.parse(reader.result); if(isKidLayout(obj)){ applyKidLayout(obj); alert('ì‚¬ìš©ì ë ˆì´ì•„ì›ƒì„ ë¶ˆëŸ¬ì™”ì–´ìš”.'); } else { state=obj; alert('ì¼ë°˜ ì €ì¥ ë°ì´í„°ë¡œ ë¶ˆëŸ¬ì™”ì–´ìš”.'); } save(); renderAll(); renderRoutine(); }catch(err){ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+err.message);} }; reader.readAsText(e.target.files[0]); });
  setTab('dashboard'); renderAll();
});

/* ===== Persistence (UPDATED for multi-key compatibility) ===== */
function load(){
  // ì—¬ëŸ¬ í˜¸í™˜ í‚¤ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ê²€ì‚¬í•´ì„œ, ê°€ì¥ ë¨¼ì € ì„±ê³µì ìœ¼ë¡œ íŒŒì‹±ë˜ëŠ” ë°ì´í„°ë¥¼ ì‚¬ìš©
  for(const k of COMPAT_KEYS){
    const raw = Store.get(k);
    if(!raw) continue;
    try{
      state = JSON.parse(raw);
      // console.log('[compat load] loaded from', k);
      return;
    }catch(_e){ /* ë‹¤ìŒ í‚¤ ì‹œë„ */ }
  }
  // ì•„ë¬´ê²ƒë„ ëª» ì°¾ìœ¼ë©´ ì´ˆê¸° ìƒíƒœ
  state={routine:null, stickers:0, coupons:0, awardedDates:{}, happyDays:{}};
}
function save(){ Store.set(SAVE_KEY, JSON.stringify(state)); }

/* ===== Tabs ===== */
function setTab(name){
  document.querySelectorAll('.tab').forEach(el=> el.classList.toggle('active', el.dataset.action===`tab:${name}`));
  document.getElementById('view-dashboard').classList.toggle('hidden', name!=='dashboard');
  document.getElementById('view-routine').classList.toggle('hidden', name!=='routine');
  if(name==='dashboard') renderDashboard(); else renderRoutine();
}

/* ===== Kid Layout Import ===== */
function isKidLayout(obj){ return obj && typeof obj.isoYear==='number' && typeof obj.isoWeek==='number' && Array.isArray(obj.subjects) && Array.isArray(obj.tasks) && obj.alloc; }
function applyKidLayout(data){
  const dayKeys=["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† ","ì¼"];
  const subjMap={}; (data.subjects||[]).forEach(s=>{ subjMap[s.id]={ name:s.name||s.id, color:s.color||null }; });
  const [ws,we]=weekStartEnd(data.isoYear, data.isoWeek);
  const weekDates=[]; for(let d=new Date(ws); d<=we; d=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1)){ weekDates.push(fmtDate(d)); }
  state.routine={ tasks:[], allocBool:{}, doneDates:{} };
  (data.tasks||[]).forEach(t=>{
    const id=t.id||('r_'+uid()); const subjectName=(subjMap[t.subject]?.name)||t.subject||'ê¸°íƒ€';
    state.routine.tasks.push({ id, subject:subjectName, title:t.title||'ê³¼ì œ', unitMinutes:t.unitMinutes||20 });
    state.routine.allocBool[id] = {"ì›”":false,"í™”":false,"ìˆ˜":false,"ëª©":false,"ê¸ˆ":false,"í† ":false,"ì¼":false};
    if(data.alloc && data.alloc[id]) dayKeys.forEach(k=> state.routine.allocBool[id][k]=!!data.alloc[id][k]);
    state.routine.doneDates[id] = {}; // doneì€ ì‚¬ìš©ìê°€ ì²´í¬ë¡œ ê´€ë¦¬
  });
  const rangeEl=document.getElementById('week-range'); if(rangeEl) rangeEl.textContent=`${fmtDate(new Date(ws))} ~ ${fmtDate(new Date(we))}`;
}

/* ===== Routine ===== */
function seedRoutine(){ state.routine={ tasks:[ {id:'r_read',subject:'êµ­ì–´',title:'ë…ì„œ 20ë¶„',unitMinutes:20}, {id:'r_math',subject:'ìˆ˜í•™',title:'ë¬¸ì œ 10ê°œ',unitMinutes:20}, {id:'r_eng',subject:'ì˜ì–´',title:'ë‹¨ì–´ 15ê°œ',unitMinutes:15}, {id:'r_music',subject:'ìŒì•…',title:'í”¼ì•„ë…¸ 20ë¶„',unitMinutes:20}], allocBool:{}, doneDates:{} }; state.routine.tasks.forEach(t=>{ state.routine.allocBool[t.id]={"ì›”":true,"í™”":false,"ìˆ˜":true,"ëª©":false,"ê¸ˆ":true,"í† ":false,"ì¼":false}; state.routine.doneDates[t.id]={}; }); save(); }
function ensureAllocBool(taskId){ if(!state.routine.allocBool) state.routine.allocBool={}; if(!state.routine.allocBool[taskId]) state.routine.allocBool[taskId] = {"ì›”":false,"í™”":false,"ìˆ˜":false,"ëª©":false,"ê¸ˆ":false,"í† ":false,"ì¼":false}; }
function ensureDoneDates(taskId){ if(!state.routine.doneDates) state.routine.doneDates={}; if(!state.routine.doneDates[taskId]) state.routine.doneDates[taskId] = {}; }
function renderRoutine(){ renderRoutineTasks(); renderRoutinePlan(); }
function renderRoutineTasks(){ const tbody=document.querySelector('#routine-task-table tbody'); tbody.innerHTML=''; state.routine.tasks.forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.subject}</td><td class="left">${t.title}</td><td>${t.unitMinutes}</td>`; const td=document.createElement('td'); const edit=document.createElement('button'); edit.className='btn'; edit.textContent='ìˆ˜ì •'; const del=document.createElement('button'); del.className='btn danger'; del.textContent='ì‚­ì œ'; del.style.marginLeft='6px'; edit.onclick=()=>{ const ns=prompt('ê³¼ëª©',t.subject); if(ns===null) return; const nt=prompt('ì œëª©',t.title); if(nt===null) return; const um=prompt('ë‹¨ìœ„ ë¶„',t.unitMinutes); if(um===null) return; t.subject=ns||t.subject; t.title=nt||t.title; t.unitMinutes=parseInt(um)||t.unitMinutes; save(); renderRoutine(); renderDashboard(); }; del.onclick=()=>{ if(state.routine.allocBool) delete state.routine.allocBool[t.id]; if(state.routine.doneDates) delete state.routine.doneDates[t.id]; state.routine.tasks=state.routine.tasks.filter(x=>x!==t); save(); renderRoutine(); renderDashboard(); }; td.appendChild(edit); td.appendChild(del); tr.appendChild(td); tbody.appendChild(tr); }); }
document.getElementById('r-btn-task-add').addEventListener('click',()=>{ const subject=(document.getElementById('r-new-subj').value||'').trim(); const title=(document.getElementById('r-new-title').value||'').trim(); const unitMinutes=parseInt(document.getElementById('r-new-min').value)||15; if(!subject||!title){ alert('ê³¼ëª©/ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; } const id='r_'+uid(); const t={id,subject,title,unitMinutes}; state.routine.tasks.push(t); ensureAllocBool(id); ensureDoneDates(id); save(); renderRoutine(); renderDashboard(); document.getElementById('r-new-subj').value=''; document.getElementById('r-new-title').value=''; document.getElementById('r-new-min').value=''; });
function renderRoutinePlan(){ const tbody=document.querySelector('#routine-plan-table tbody'); tbody.innerHTML=''; const days=["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† ","ì¼"]; const [y,w]=getISOWeek(new Date()); const [ws,we]=weekStartEnd(y,w); const weekDatesArr=[]; for(let d=new Date(ws); d<=we; d=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1)){ weekDatesArr.push(fmtDate(d)); } state.routine.tasks.forEach(t=>{ ensureAllocBool(t.id); ensureDoneDates(t.id); const tr=document.createElement('tr'); const tdTask=document.createElement('td'); tdTask.className='left'; tdTask.innerHTML=`<strong>${t.title}</strong> <span class="small">(${t.subject} Â· ${t.unitMinutes}ë¶„)</span>`; tr.appendChild(tdTask); let assigned=0; days.forEach(d=>{ const td=document.createElement('td'); const on=!!state.routine.allocBool[t.id][d]; if(on) assigned++; const btn=document.createElement('button'); btn.type='button'; btn.className='daybtn'+(on?' on':''); btn.textContent= on ? 'ë°°ì •ë¨' : 'ë°°ì • ì•ˆí•¨'; btn.setAttribute('aria-pressed', on ? 'true' : 'false'); btn.onclick=()=>{ state.routine.allocBool[t.id][d]=!on; save(); renderRoutine(); renderDashboard(); }; btn.onkeydown=ev=>{ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); btn.click(); } }; td.appendChild(btn); tr.appendChild(td); }); let doneCount=0; const doneMap=state.routine.doneDates[t.id]||{}; const doneSet=new Set(); Object.keys(doneMap).forEach(ds=>{ if(doneMap[ds] && isBetweenDates(ds,ws,we)){ const kd=dateToKDay(ds); if(state.routine.allocBool[t.id][kd]){ doneCount++; doneSet.add(ds);} } }); weekDatesArr.forEach(ds=>{ if(state.happyDays && state.happyDays[ds]){ const kd=dateToKDay(ds); if(state.routine.allocBool[t.id][kd] && !doneSet.has(ds)) doneCount++; } }); const tdSum=document.createElement('td'); const pct=assigned>0?Math.round((doneCount/assigned)*100):0; tdSum.innerHTML=`<div class="small">ë°°ì • ${assigned} Â· ì™„ë£Œ ${doneCount}</div><div class="minibar"><span style="width:${pct}%"></span></div>`; tr.appendChild(tdSum); tbody.appendChild(tr); }); }

/* ===== Dashboard ===== */
function renderDashboard(){ renderTodayList(); renderBacklogList(); renderWeeklySummaryCard(); renderStickerBank(); }

function renderTodayList(){
  const host=document.getElementById('today-list'); host.innerHTML='';
  const today=fmtDate(new Date());
  const todayName=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][new Date().getDay()];
  if(state.happyDays && state.happyDays[today]){
    host.innerHTML = '<div class="badge-chip">ğŸ‰ í•´í”¼ë°ì´! ì˜¤ëŠ˜ì€ ì‰¬ëŠ” ë‚ ì´ì—ìš”.</div>';
    return; // í•´í”¼ë°ì´ëŠ” ìŠ¤í‹°ì»¤ ìë™ ì§€ê¸‰ ì—†ìŒ
  }
  let total=0, done=0;
  state.routine.tasks.forEach(t=>{
    ensureAllocBool(t.id); ensureDoneDates(t.id);
    const on = state.routine.allocBool[t.id][todayName];
    if(on){
      total++;
      const isDone = !!state.routine.doneDates[t.id][today];
      if(isDone) done++;
      const row=document.createElement('label'); row.className='tag'+(isDone?' done':''); 
      const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=isDone;
      ck.onchange=()=>{ state.routine.doneDates[t.id][today]=ck.checked; save(); renderDashboard(); };
      const txt=document.createElement('span'); txt.textContent = `${t.subject} Â· ${t.title}`;
      row.appendChild(ck); row.appendChild(txt); host.appendChild(row);
    }
  });
  if(total===0){ host.innerHTML='<div class="tiny">ì˜¤ëŠ˜ë¡œ ë°°ì •ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; }
  // ì˜¤ëŠ˜ í•­ëª© ëª¨ë‘ ì™„ë£Œ ì‹œ ìŠ¤í‹°ì»¤ 1ê°œ ì§€ê¸‰ (í•˜ë£¨ 1íšŒ)
  if(total>0 && done===total){
    if(!state.awardedDates) state.awardedDates={};
    const todayStr=today;
    if(!state.awardedDates[todayStr]){
      state.awardedDates[todayStr]=true;
      state.stickers = (state.stickers||0) + 1;
      save();
      const sEl=document.getElementById('sticker-count'); if(sEl) sEl.textContent=state.stickers;
    }
  }
}

// NEW: Backlog list (missed tasks within this week, excluding today and excluding happyDays)
function renderBacklogList(){
  const host=document.getElementById('backlog-list'); if(!host) return;
  host.innerHTML='';
  const now=new Date();
  const [y,w]=getISOWeek(now); const [ws,we]=weekStartEnd(y,w);
  const todayStr=fmtDate(now);
  // ë‚ ì§œ ë¦¬ìŠ¤íŠ¸: ì´ë²ˆ ì£¼ ì›”ìš”ì¼ ~ ì–´ì œ
  const dates=[];
  for(let d=new Date(ws); d<now; d=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1)){
    const ds=fmtDate(d);
    if(ds===todayStr) break;
    dates.push(ds);
  }
  let count=0;
  state.routine.tasks.forEach(t=>{
    ensureAllocBool(t.id); ensureDoneDates(t.id);
    dates.forEach(ds=>{
      // í•´í”¼ë°ì´ëŠ” ë©´ì œ
      if(state.happyDays && state.happyDays[ds]) return;
      const dayName=dateToKDay(ds);
      if(state.routine.allocBool[t.id][dayName] && !state.routine.doneDates[t.id][ds]){
        const row=document.createElement('label'); row.className='tag';
        const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=false;
        ck.onchange=()=>{ state.routine.doneDates[t.id][ds]=true; save(); maybeAwardStickerForDate(ds); renderDashboard(); };
        const txt=document.createElement('span'); txt.textContent=`${t.subject} Â· ${t.title} (${dayName})`;
        row.appendChild(ck); row.appendChild(txt); host.appendChild(row);
        count++;
      }
    });
  });
  if(count===0){
    host.innerHTML='<div class="tiny">ë°€ë¦° í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì˜í•˜ê³  ìˆì–´ìš”! ğŸ‘</div>';
  }
}

// Helper: retro-award sticker for a specific date if that day's all assigned tasks are done
function maybeAwardStickerForDate(ds){
  // no sticker if the day was set as happy day
  if(state.happyDays && state.happyDays[ds]) return;
  if(!state.awardedDates) state.awardedDates = {};
  if(state.awardedDates[ds]) return;
  const dayName = dateToKDay(ds);
  let assigned = 0, done = 0;
  state.routine.tasks.forEach(t=>{
    ensureAllocBool(t.id); ensureDoneDates(t.id);
    if(state.routine.allocBool[t.id][dayName]){
      assigned++;
      if(state.routine.doneDates[t.id][ds]) done++;
    }
  });
  if(assigned>0 && done===assigned){
    state.awardedDates[ds] = true;
    state.stickers = (state.stickers||0) + 1;
    save();
  }
}


/* ===== Print Today's Tasks ===== */
(function(){
  document.addEventListener('click', function(e){
    const btn = e.target.closest('#btn-print-today');
    if(!btn) return;
    try{
      const now = new Date();
      const todayStr = fmtDate(now);
      const todayName = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][now.getDay()];
      if(!state || !state.routine || !state.routine.tasks || state.routine.tasks.length===0){
        alert('í•  ì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      // Collect today's assigned tasks (regardless of current completion)
      const items = [];
      state.routine.tasks.forEach(t=>{
        ensureAllocBool(t.id); ensureDoneDates(t.id);
        if(state.routine.allocBool[t.id][todayName]){
          items.push(`${t.subject} Â· ${t.title}`);
        }
      });
      if(items.length===0){
        alert('ì˜¤ëŠ˜ë¡œ ë°°ì •ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      // Populate print sheet
      const pDate = document.getElementById('print-date');
      const pList = document.getElementById('print-list');
      if(pDate) pDate.textContent = `${todayStr} (${todayName})`;
      if(pList){
        pList.innerHTML = '';
        items.forEach((txt,i)=>{
          const li = document.createElement('li');
          li.textContent = `â˜ ${txt}`;
          pList.appendChild(li);
        });
      }
      // Show print-sheet and trigger window.print()
      const sheet = document.getElementById('print-sheet');
      if(sheet) sheet.classList.remove('hidden');
      window.print();
      // After printing, hide the sheet again
      setTimeout(()=>{ if(sheet) sheet.classList.add('hidden'); }, 100);
    }catch(err){
      alert('ì¸ì‡„ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
    }
  });
})();
function weeklyAssignedDone(){ const [y,w]=getISOWeek(new Date()); const [ws,we]=weekStartEnd(y,w); const days=["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† ","ì¼"]; const weekDatesArr=[]; for(let d=new Date(ws); d<=we; d=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1)){ weekDatesArr.push(fmtDate(d)); } let totalAssigned=0,totalDone=0; state.routine.tasks.forEach(t=>{ const assigned=days.reduce((acc,d)=>acc+(state.routine.allocBool[t.id][d]?1:0),0); totalAssigned+=assigned; let done=0; const dm=state.routine.doneDates[t.id]||{}; const doneSet=new Set(); Object.keys(dm).forEach(ds=>{ if(dm[ds] && isBetweenDates(ds,ws,we)){ const kd=dateToKDay(ds); if(state.routine.allocBool[t.id][kd]){ done++; doneSet.add(ds);} } }); weekDatesArr.forEach(ds=>{ if(state.happyDays && state.happyDays[ds]){ const kd=dateToKDay(ds); if(state.routine.allocBool[t.id][kd] && !doneSet.has(ds)) done++; } }); totalDone+=done; }); return {totalAssigned,totalDone}; }
function renderWeeklySummaryCard(){ const bar=document.getElementById('weekly-bar'); const txt=document.getElementById('weekly-text'); const list=document.getElementById('weekly-list'); list.innerHTML=''; const [y,w]=getISOWeek(new Date()); const [ws,we]=weekStartEnd(y,w); const days=["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† ","ì¼"]; const weekDatesArr=[]; for(let d=new Date(ws); d<=we; d=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1)){ weekDatesArr.push(fmtDate(d)); } let totalAssigned=0,totalDone=0; state.routine.tasks.forEach(t=>{ ensureAllocBool(t.id); ensureDoneDates(t.id); const assigned=days.reduce((acc,d)=>acc+(state.routine.allocBool[t.id][d]?1:0),0); totalAssigned+=assigned; let done=0; const dm=state.routine.doneDates[t.id]||{}; const doneSet=new Set(); Object.keys(dm).forEach(ds=>{ if(dm[ds] && isBetweenDates(ds,ws,we)){ const kd=dateToKDay(ds); if(state.routine.allocBool[t.id][kd]){ done++; doneSet.add(ds);} } }); weekDatesArr.forEach(ds=>{ if(state.happyDays && state.happyDays[ds]){ const kd=dateToKDay(ds); if(state.routine.allocBool[t.id][kd] && !doneSet.has(ds)) done++; } }); totalDone+=done; const card=document.createElement('div'); card.className='tcard'; const head=document.createElement('div'); head.className='thead'; head.textContent=`${t.subject} Â· ${t.title}`; const info=document.createElement('div'); info.className='info'; info.textContent=`ë°°ì • ${assigned} Â· ì™„ë£Œ ${done}`; const pct=assigned>0?Math.round((done/assigned)*100):0; const barMini=document.createElement('div'); barMini.className='minibar'; const span=document.createElement('span'); span.style.width=pct+'%'; barMini.appendChild(span); card.appendChild(head); card.appendChild(info); card.appendChild(barMini); list.appendChild(card); }); const {totalAssigned:a,totalDone:d}= {totalAssigned,totalDone}; const pctAll=a>0?Math.round((d/a)*100):0; bar.style.width=pctAll+'%'; txt.textContent=`ë°°ì • ${a} Â· ì™„ë£Œ ${d}`; }

/* ===== Gamify ===== */
function ensureGamify(){ if(state.stickers===undefined) state.stickers=0; if(state.coupons===undefined) state.coupons=0; if(!state.awardedDates) state.awardedDates={}; if(!state.happyDays) state.happyDays={}; }
function renderStickerBank(){ ensureGamify(); const sEl=document.getElementById('sticker-count'); const cEl=document.getElementById('coupon-count'); const btnUse=document.getElementById('btn-use-coupon'); const btnConvert=document.getElementById('btn-convert-coupon'); const status=document.getElementById('coupon-status'); const dateInput=document.getElementById('coupon-date'); const today=fmtDate(new Date()); if(dateInput && !dateInput.value) dateInput.value=today; const selected=dateInput?dateInput.value:today; if(sEl) sEl.textContent=state.stickers||0; if(cEl) cEl.textContent=state.coupons||0; if(btnConvert){ btnConvert.disabled=(state.stickers||0)<50; btnConvert.onclick=()=>{ if((state.stickers||0)<50) return; state.stickers-=50; state.coupons=(state.coupons||0)+1; save(); renderStickerBank(); }; }
  if(btnUse){ const already=!!(state.happyDays&&state.happyDays[selected]); btnUse.disabled=(state.coupons||0)<=0||already||!selected; btnUse.onclick=()=>{ if((state.coupons||0)<=0||!dateInput||!dateInput.value) return; const sel=dateInput.value; if(state.happyDays&&state.happyDays[sel]) return; state.coupons-=1; if(!state.happyDays) state.happyDays={}; state.happyDays[sel]=true; save(); renderAll(); }; if(dateInput){ dateInput.onchange=()=>{ renderStickerBank(); }; } }
  if(status){ const sel=dateInput?dateInput.value:today; status.textContent= sel && state.happyDays && state.happyDays[sel] ? `${sel}ì€ ì´ë¯¸ í•´í”¼ë°ì´ë¡œ ì§€ì •ë¨` : ''; }
}


/* ===== GitHub Gist Sync ===== */
const GIST_TOKEN_KEY = "midplanner:gist_token";
const GIST_ID_KEY = "midplanner:gist_id";

function loadGistConfigUI(){
  const t = localStorage.getItem(GIST_TOKEN_KEY) || "";
  const g = localStorage.getItem(GIST_ID_KEY) || "";
  const tEl = document.getElementById('gist-token');
  const gEl = document.getElementById('gist-id');
  if(tEl) tEl.value = t;
  if(gEl) gEl.value = g;
}

async function gistSave(){
  const status = (msg)=>{ const s=document.getElementById('gist-status'); if(s) s.textContent=msg; };
  try{
    const token = (document.getElementById('gist-token')?.value||"").trim();
    const gistId = (document.getElementById('gist-id')?.value||"").trim();
    if(!token){ alert("GitHub Tokenì„ ì…ë ¥í•´ì£¼ì„¸ìš” (gist ê¶Œí•œ í•„ìˆ˜)."); return; }
    // persist token/id locally for convenience
    localStorage.setItem(GIST_TOKEN_KEY, token);
    if(gistId) localStorage.setItem(GIST_ID_KEY, gistId);

    const payload = {
      description: "Study Planner state backup",
      public: false,
      files: {
        "planner_state.json": { content: JSON.stringify(state, null, 2) }
      }
    };

    status("Gist ì €ì¥ ì¤‘...");
    let res;
    if(gistId){
      // update
      res = await fetch(`https://api.github.com/gists/${gistId}`, {
        method: "PATCH",
        headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" },
        body: JSON.stringify({ files: payload.files })
      });
    }else{
      // create
      res = await fetch("https://api.github.com/gists", {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" },
        body: JSON.stringify(payload)
      });
    }
    if(!res.ok){
      const text = await res.text();
      throw new Error(text || `HTTP ${res.status}`);
    }
    const data = await res.json();
    const newId = data.id;
    if(newId){
      localStorage.setItem(GIST_ID_KEY, newId);
      const idEl=document.getElementById('gist-id'); if(idEl) idEl.value=newId;
    }
    status(`ì €ì¥ ì™„ë£Œ! Gist ID: ${localStorage.getItem(GIST_ID_KEY)}`);
    alert("Gist ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
  }catch(err){
    console.error(err);
    alert("Gist ì €ì¥ ì‹¤íŒ¨: " + err.message);
  }
}

async function gistLoad(){
  const status = (msg)=>{ const s=document.getElementById('gist-status'); if(s) s.textContent=msg; };
  try{
    const token = (document.getElementById('gist-token')?.value||"").trim();
    const gistId = (document.getElementById('gist-id')?.value||"").trim() || localStorage.getItem(GIST_ID_KEY);
    if(!gistId){ alert("Gist IDê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì €ì¥í•˜ê±°ë‚˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
    if(token) localStorage.setItem(GIST_TOKEN_KEY, token);
    localStorage.setItem(GIST_ID_KEY, gistId);

    status("Gist ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
    const res = await fetch(`https://api.github.com/gists/${gistId}`, {
      headers: token ? { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github+json" } : { "Accept":"application/vnd.github+json" }
    });
    if(!res.ok){
      const text = await res.text();
      throw new Error(text || `HTTP ${res.status}`);
    }
    const data = await res.json();
    const file = data.files?.["planner_state.json"];
    if(!file || !file.content){ throw new Error("planner_state.json íŒŒì¼ì„ Gistì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }

    // apply state
    const obj = JSON.parse(file.content);
    state = obj;
    save();
    renderAll();
    status("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ.");
    alert("Gistì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
  }catch(err){
    console.error(err);
    alert("Gist ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message);
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  // bind UI
  const sBtn = document.getElementById('btn-gist-save');
  const lBtn = document.getElementById('btn-gist-load');
  if(sBtn) sBtn.addEventListener('click', gistSave);
  if(lBtn) lBtn.addEventListener('click', gistLoad);
  loadGistConfigUI();
});

/* ===== Reset Buttons ===== */
(function(){ const resetAll=document.getElementById('btn-reset-all'); if(resetAll){ resetAll.addEventListener('click',()=>{ if(!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return; localStorage.removeItem(SAVE_KEY); state={routine:null, stickers:0, coupons:0, awardedDates:{}, happyDays:{}}; seedRoutine(); renderAll(); }); } const resetWeek=document.getElementById('btn-reset-week'); if(resetWeek){ resetWeek.addEventListener('click',()=>{ if(!confirm('ì´ë²ˆ ì£¼ì˜ ì™„ë£Œ ê¸°ë¡ì„ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?')) return; if(!state.routine||!state.routine.doneDates) return; const [y,w]=getISOWeek(new Date()); const [ws,we]=weekStartEnd(y,w); Object.keys(state.routine.doneDates).forEach(tid=>{ const dm=state.routine.doneDates[tid]||{}; Object.keys(dm).forEach(ds=>{ if(isBetweenDates(ds,ws,we)) delete dm[ds]; }); }); save(); renderAll(); }); }
})();

/* ===== Render All ===== */
function renderAll(){ renderDashboard(); renderRoutine(); }
</script>

  <!-- Print Sheet for Today's Tasks -->
  <div id="print-sheet" class="hidden">
    <div style="max-width:700px;margin:0 auto;padding:24px;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Malgun Gothic,Arial;color:#111">
      <h1 style="margin:0 0 6px 0;font-size:24px;letter-spacing:-.3px">ì˜¤ëŠ˜ í•  ì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>
      <div id="print-date" style="color:#555;margin-bottom:14px;font-size:14px"></div>
      <ol id="print-list" style="padding-left:18px;margin:0 0 18px 0;line-height:1.8"></ol>
      <div style="margin-top:24px;font-size:14px;color:#444;display:flex;justify-content:space-between;gap:16px">
        <div>ë³´ìƒ ìŠ¤í‹°ì»¤: â˜</div>
        <div>í™•ì¸(ë³´í˜¸ì ì„œëª…): ______________________</div>
      </div>
    </div>
  </div>
</body>
</html>

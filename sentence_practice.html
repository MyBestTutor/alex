<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<title>🎙️ 발음 연습 놀이 (TTS 컨트롤 포함)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root{
    --mint:#ecfdf5; --mint3:#a7f3d0; --mint6:#10b981; --ink:#064e3b; --gray:#6b7280;
  }
  *{box-sizing:border-box}
  body{ margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px;
        background:linear-gradient(180deg,#f0fdf4,#ecfeff); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color:var(--ink); }
  .wrap{ width:min(900px,96vw); background:#ffffffee; backdrop-filter:blur(8px); border-radius:24px; padding:20px;
         border:1px solid rgba(0,0,0,.06); box-shadow:0 24px 48px rgba(0,0,0,.08); }
  h1{ margin:0 0 8px; font-size:2rem; color:#059669; text-align:center; }
  a.home{ text-decoration:none; background:linear-gradient(180deg, #10b981, #059669); color:#fff; padding:10px 14px; border-radius:12px; display:inline-block; margin-bottom:10px; font-weight:900; }
  .ttsbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; margin:8px 0 12px;}
  .ttsbar label{ font-weight:800; }
  .quiz{ background:#fff; border-radius:18px; border:1px solid rgba(0,0,0,.06); box-shadow:0 12px 20px rgba(0,0,0,.08); padding:18px; }
  .sentence{ min-height:70px; padding:18px; font-size:1.6rem; font-weight:900; color:#065f46; background:#ecfeff; border:3px dashed var(--mint3); border-radius:16px; display:flex; align-items:center; justify-content:center; margin-bottom:16px; }
  .row{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:6px; }
  .btn{ padding:12px 18px; border:none; border-radius:14px; font-weight:900; cursor:pointer; color:#fff; background:#10b981; box-shadow:0 8px 16px rgba(16,185,129,.25); }
  .btn.gray{ background:var(--gray); }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
  .panel{ margin-top:14px; padding:12px; border-radius:12px; background:#f7fee7; border:1px dashed var(--mint3); display:none; }
</style>
</head>
<body>
<div class="wrap">
  <h1>🎙️ 발음 연습 놀이</h1>
  <a href="index.html" class="home">🏠 홈으로</a>

  <!-- TTS Controls -->
  <div class="ttsbar">
    <label>🎚️ 속도 <input id="ttsRate" type="range" min="0.5" max="1.2" step="0.05" value="0.85"></label>
    <label>🎵 톤 <input id="ttsPitch" type="range" min="0.8" max="1.3" step="0.05" value="1.00"></label>
    <label>🗣️ 보이스 <select id="ttsVoice"></select></label>
  </div>

  <div id="needFile" class="panel" style="display:none;">먼저 <b>index.html</b>에서 문장 파일을 선택해 주세요.</div>

  <div class="quiz" id="game" style="display:none;">
    <div class="sentence" id="sentenceDisplay"></div>
    <div class="row">
      <button class="btn" id="btnSpeak">🎧 문장 듣기</button>
      <button class="btn" id="btnRecord">🔴 녹음 시작</button>
      <button class="btn gray" id="btnPlay" disabled>🔈 내 발음 듣기</button>
      <button class="btn" id="btnAnalyze" disabled>🟣 발음 분석</button>
      <button class="btn gray" id="btnNext">➡️ 다음 문장</button>
    </div>
    <div class="panel" id="resultBox"></div>
  </div>
</div>

<script>
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let voices=[], quiz=[], idx=0, isRec=false, mediaRecorder, chunks=[], blob=null;

const $ = id => document.getElementById(id);
function loadFromSession(){
  try{
    const raw = sessionStorage.getItem('SENTENCE_LIST_JSON');
    if(!raw) return null;
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)&&arr.length>0) return arr.map(s=>String(s));
  }catch(e){}
  return null;
}

function populateVoices(){
  voices = speechSynthesis.getVoices();
  const sel = $('ttsVoice'); if(!sel) return;
  const keep = localStorage.getItem('VOICE_NAME');
  sel.innerHTML = '';
  const en = voices.filter(v=>v.lang && v.lang.toLowerCase().startsWith('en'));
  en.forEach(v=>{
    const opt=document.createElement('option');
    opt.value=v.name; opt.textContent=v.name+' ('+v.lang+')';
    if(keep===v.name) opt.selected=true;
    sel.appendChild(opt);
  });
}
function bindTtsControls(){
  const r=$('ttsRate'), p=$('ttsPitch'), v=$('ttsVoice');
  if(r){ const keep=localStorage.getItem('TTS_RATE'); if(keep) r.value=keep; r.addEventListener('input',()=>localStorage.setItem('TTS_RATE', r.value)); }
  if(p){ const keep=localStorage.getItem('TTS_PITCH'); if(keep) p.value=keep; p.addEventListener('input',()=>localStorage.setItem('TTS_PITCH', p.value)); }
  if(v){ const keep=localStorage.getItem('VOICE_NAME'); if(keep) v.value=keep; v.addEventListener('change',()=>localStorage.setItem('VOICE_NAME', v.value)); }
}
function getTtsSettings(){
  return {
    rate: parseFloat(localStorage.getItem('TTS_RATE')||$('ttsRate')?.value||'0.85'),
    pitch: parseFloat(localStorage.getItem('TTS_PITCH')||$('ttsPitch')?.value||'1.0'),
    voiceName: localStorage.getItem('VOICE_NAME')||$('ttsVoice')?.value||''
  };
}

function speak(){
  if(!quiz.length) return;
  const s = quiz[idx];
  if('speechSynthesis' in window){
    if(speechSynthesis.speaking) speechSynthesis.cancel();
    const set = getTtsSettings();
    const u = new SpeechSynthesisUtterance(s);
    const v = voices.find(v=> set.voiceName ? v.name===set.voiceName : (v.lang && v.lang.startsWith('en-')));
    if(v) u.voice=v;
    u.lang='en-US'; u.rate=set.rate; u.pitch=set.pitch;
    speechSynthesis.speak(u);
  }
}

function loadQuestion(){
  $('sentenceDisplay').textContent = quiz[idx];
  $('resultBox').style.display='none'; blob=null; $('btnPlay').disabled=true; $('btnAnalyze').disabled=true;
}
async function toggleRec(){
  if(isRec){ mediaRecorder.stop(); $('btnRecord').textContent='처리 중...'; $('btnRecord').disabled=true; isRec=false; return; }
  try{
    chunks=[];
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = ()=>{
      blob = new Blob(chunks,{type:'audio/wav'});
      stream.getTracks().forEach(t=>t.stop());
      $('btnRecord').textContent='🔴 녹음 시작'; $('btnRecord').disabled=false;
      $('btnPlay').disabled=false; $('btnAnalyze').disabled=false;
    };
    mediaRecorder.start();
    $('btnRecord').textContent='🎚️ 녹음 중지'; isRec=true;
  }catch(e){ alert('마이크 권한을 허용해 주세요.'); $('btnRecord').textContent='🔴 녹음 시작'; isRec=false; }
}
function playRec(){ if(!blob) return alert('녹음 먼저!'); new Audio(URL.createObjectURL(blob)).play(); }
function analyze(){
  if(!SR) return alert('음성 인식을 지원하지 않습니다.');
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    const rec = new SR(); rec.lang='en-US'; rec.interimResults=false; rec.maxAlternatives=1;
    $('resultBox').style.display='none'; rec.start();
    rec.onresult = e=>{
      const heard = e.results[0][0].transcript || '';
      const score = scorePron(heard, quiz[idx]);
      showResult(heard, score);
      stream.getTracks().forEach(t=>t.stop());
    };
    rec.onerror = _=>{ $('resultBox').textContent='인식 오류가 발생했어요.'; $('resultBox').style.display='block'; stream.getTracks().forEach(t=>t.stop()); };
  });
}
function scorePron(heard, target){
  const cl = t=>t.toLowerCase().replace(/[.,!?]/g,'').trim().split(/\s+/).filter(Boolean);
  const T = cl(target), H = cl(heard);
  let c=0; for(let i=0;i<H.length;i++){ if(i<T.length && H[i]===T[i]) c++; }
  return Math.round((c/Math.max(T.length,1))*100);
}
function showResult(heard, score){
  const el=$('resultBox'); el.innerHTML = `<b>점수:</b> ${score} / 100<br><b>인식:</b> ${heard}`; el.style.display='block';
}
function nextQ(){ idx=(idx+1)%quiz.length; loadQuestion(); }

function init(){
  bindTtsControls();
  if('speechSynthesis' in window){
    if(speechSynthesis.onvoiceschanged!==undefined) speechSynthesis.onvoiceschanged = populateVoices;
    populateVoices();
  }
  const arr = loadFromSession();
  if(!arr){ $('needFile').style.display='block'; return; }
  quiz = arr; $('game').style.display='block'; loadQuestion();
  $('btnSpeak').onclick=speak; $('btnRecord').onclick=toggleRec; $('btnPlay').onclick=playRec; $('btnAnalyze').onclick=analyze; $('btnNext').onclick=nextQ;
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
